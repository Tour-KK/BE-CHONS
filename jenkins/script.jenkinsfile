pipeline {
    agent any
    environment {
            SSH_PASSWORD = credentials('ncp-password')
        }
    tools {
        gradle 'gradle'
    }
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'main', url: 'https://github.com/Tour-KK/BE-CHONS.git'
            }
        }
        stage('Build') {
            steps {
                sh "./gradlew clean build"
            }
        }
        stage('Deploy') {
                    steps {
                        sshagent(credentials: ['chons-ncp']) {
                            sh '''
                                sshpass -p $SSH_PASSWORD ssh -o StrictHostKeyChecking=no root@223.130.131.166 uptime
                                sshpass -p $SSH_PASSWORD scp /var/jenkins_home/workspace/chons/build/libs/BE-CHONS-0.0.1-SNAPSHOT.jar root@223.130.131.166:/home/root/chons
                                sshpass -p $SSH_PASSWORD ssh -t root@223.130.131.166 ./deploy.sh 'nohup ./deploy.sh > /dev/null 2>&1 &'
                                # 애플리케이션 로그 확인
                                sshpass -p $SSH_PASSWORD ssh -o StrictHostKeyChecking=no root@223.130.131.166 'tail -n 50 /home/root/chons/application.log'
                                # 포트 상태 확인
                                sshpass -p $SSH_PASSWORD ssh -o StrictHostKeyChecking=no root@223.130.131.166 'netstat -tuln | grep 8080'
                            '''
                        }
                    }
        }
    }
}